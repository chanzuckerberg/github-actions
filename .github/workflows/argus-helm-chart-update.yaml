name: HelmDep Update

on:
  workflow_call:
    inputs:
      app_name:
        description: The app name to update the Helm dependencies for
        required: false
        type: string
      argus_base_url:
        description: The base URL of the Argus API to fetch app info
        required: false
        default: ""
        type: string
      chart_name:
        description: The name of the Helm chart to update
        required: false
        default: "stack"
        type: string

jobs:
  fetch-app-info:
    name: Fetch app info
    runs-on: ubuntu-latest
    outputs:
      app_envs_to_update: ${{ steps.process_apps_outputs.outputs.app_envs_to_update }}
    permissions:
      id-token: write
      contents: read
    steps:
      - name: List apps
        id: list_apps
        uses: chanzuckerberg/argus-artifacts/ci/packages/list-apps@v0
        env:
          PLATFORM_BASE_URL: ${{ inputs.argus_base_url }}
      - name: Process apps outputs
        id: process_apps_outputs
        uses: actions/github-script@v7
        with:
          script: |
            core.group("Retrieved apps from Argus", () => {
              const apps = ${{ steps.list_apps.outputs.apps }};

              const ownerAndRepo = '${{ github.repository }}';
              const appsToUpdate = `${{ inputs.app_name }}` ? apps.filter(app => app.name === `${{ inputs.app_name }}`) : apps.filter(app => app.repo_slug === ownerAndRepo);
              core.info(`Checking for Helm chart updates for apps: ${JSON.stringify(appsToUpdate.map(app => app.name), null, 2)}`);

              // Flatten apps and environments into a matrix
              const matrixItems = [];
              appsToUpdate.forEach(app => {
                if (app.envs && Array.isArray(app.envs)) {
                  app.envs.forEach(env => {
                    matrixItems.push({
                      app_name: app.name,
                      env_name: env.name,
                      project_root_path: app.project_root_path,
                      repo_slug: app.repo_slug
                    });
                  });
                }
              });

              core.info(`Matrix will process ${matrixItems.length} app-env combinations`);
              matrixItems.forEach(item => {
                core.info(` - App: ${item.app_name} Env: ${item.env_name} Project root path: ${item.project_root_path} Repo slug: ${item.repo_slug}`);
              });
              core.setOutput("app_envs_to_update", JSON.stringify(matrixItems));
            });
  update-helm-deps:
    name: Update Helm Dependencies
    needs: [fetch-app-info]
    runs-on: ubuntu-latest
    if: needs.fetch-app-info.outputs.app_envs_to_update != '[]' && needs.fetch-app-info.outputs.app_envs_to_update != ''
    permissions:
      id-token: write
      contents: read
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.fetch-app-info.outputs.app_envs_to_update) }}
    steps:
      - name: Log info
        run: |
          echo "Updating chart for app: ${{ matrix.app_name }} in env: ${{ matrix.env_name }} - app root dir: ${{ matrix.project_root_path }}"
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup updatecli
        uses: updatecli/updatecli-action@v2
      - name: Generate token
        id: generate_token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.GH_ACTIONS_HELPER_APP_ID }}
          private-key: ${{ secrets.GH_ACTIONS_HELPER_PK }}
      - name: Check chart path
        id: check_chart_path
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            const projectRootPath = '${{ matrix.project_root_path }}';
            const envName = '${{ matrix.env_name }}';

            const chartPath = path.join(projectRootPath, '.infra', envName, 'Chart.yaml');
            core.setOutput('chart_path', chartPath);

            const exists = fs.existsSync(chartPath);
            core.setOutput('chart_exists', exists.toString());

            if (exists) {
              core.info(`Chart path exists: ${chartPath}`);
            } else {
              core.warning(`Chart path does not exist: ${chartPath}`);
            }

      - uses: actions/setup-node@v4
        if: steps.check_chart_path.outputs.chart_exists == 'true'
      - name: Install js-yaml in isolated directory
        if: steps.check_chart_path.outputs.chart_exists == 'true'
        # Install js-yaml in an isolated directory in case the repo already has a package installed that conflicts with js-yaml
        run: |
          mkdir -p /tmp/js-yaml-install
          cd /tmp/js-yaml-install
          npm install js-yaml --no-save
      - name: Find chart repository URL
        id: find_chart_url
        if: steps.check_chart_path.outputs.chart_exists == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const yaml = require('/tmp/js-yaml-install/node_modules/js-yaml');
            const chartPath = '${{ steps.check_chart_path.outputs.chart_path }}';
            const chartName = '${{ inputs.chart_name }}';

            // Read Chart.yaml and find the repository URL for the specified chart
            const chartContent = fs.readFileSync(chartPath, 'utf8');
            const chartYaml = yaml.load(chartContent);

            const dependency = chartYaml.dependencies?.find(dep => dep.name === chartName);

            if (dependency && dependency.repository) {
              core.setOutput('chart_repository', dependency.repository);
              core.setOutput('repository_found', 'true');
              core.info(`Found repository for ${chartName}: ${dependency.repository}`);
            } else {
              core.warning(`Could not find repository URL for chart: ${chartName}`);
              core.setOutput('repository_found', 'false');
            }
      - name: Write updatecli manifest
        id: write_manifest
        if: steps.check_chart_path.outputs.chart_exists == 'true' && steps.find_chart_url.outputs.repository_found == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const yaml = require('/tmp/js-yaml-install/node_modules/js-yaml');
            const appName = '${{ matrix.app_name }}';
            const envName = '${{ matrix.env_name }}';
            const chartPath = '${{ steps.check_chart_path.outputs.chart_path }}';
            const chartName = '${{ inputs.chart_name }}';
            const chartRepository = '${{ steps.find_chart_url.outputs.chart_repository }}';

            const fileName = 'updatecli-' + appName + '-' + envName + '.yaml';
            core.setOutput('UPDATECLI_MANIFEST_FILE', fileName);

            const manifest = {
              name: 'Helm chart update',
              sources: {
                helmChart: {
                  name: `Get the latest '${chartName}' Helm chart version`,
                  kind: 'helmchart',
                  spec: {
                    url: chartRepository,
                    name: chartName
                  }
                }
              },
              targets: {
                helmChartVersions: {
                  name: `Bump '${chartName}' Helm chart versions`,
                  kind: 'yaml',
                  spec: {
                    engine: 'yamlpath',
                    key: `$.dependencies[?(@.name == '${chartName}')].version`,
                    file: chartPath
                  }
                }
              }
            };

            const manifestContent = yaml.dump(manifest);
            fs.writeFileSync(fileName, manifestContent, 'utf8');

      - name: Run updatecli
        id: run_updatecli
        if: steps.check_chart_path.outputs.chart_exists == 'true' && steps.find_chart_url.outputs.repository_found == 'true'
        run: |
          export UPDATE_LOG_FILE=$(uuidgen)-update.log
          echo "Running updatecli with manifest ${{ steps.write_manifest.outputs.UPDATECLI_MANIFEST_FILE }}"
          cat ${{ steps.write_manifest.outputs.UPDATECLI_MANIFEST_FILE }}

          echo "----------------------------------------"
          set +e
          updatecli apply --config ${{ steps.write_manifest.outputs.UPDATECLI_MANIFEST_FILE }} >> $UPDATE_LOG_FILE 2>&1
          UPDATECLI_EXIT_CODE=$?
          set -e

          cat $UPDATE_LOG_FILE
          EOF=$(dd if=/dev/urandom bs=15 count=1 status=none | base64)
          echo "update_logs<<$EOF" >> $GITHUB_OUTPUT
          echo "$(cat $UPDATE_LOG_FILE)" >> $GITHUB_OUTPUT
          echo "$EOF" >> $GITHUB_OUTPUT
          rm $UPDATE_LOG_FILE
          rm ${{ steps.write_manifest.outputs.UPDATECLI_MANIFEST_FILE }}

          exit $UPDATECLI_EXIT_CODE

      - name: Create Pull Request
        id: create_pr
        if: steps.check_chart_path.outputs.chart_exists == 'true' && steps.find_chart_url.outputs.repository_found == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          add-paths: |
            ${{ steps.check_chart_path.outputs.chart_path }}
          commit-message: update '${{ inputs.chart_name }}' helm chart version
          title: "chore: update '${{ inputs.chart_name }}' helm chart version for ${{ matrix.app_name }} ${{ matrix.env_name }}"
          body: "```${{ steps.run_updatecli.outputs.update_logs }}\n```"
          base: ${{ github.event.repository.default_branch }}
          branch: updatecli-bump-${{ inputs.chart_name }}-chart-${{ matrix.app_name }}-${{ matrix.env_name }}
          delete-branch: true
          token: ${{ steps.generate_token.outputs.token }}
